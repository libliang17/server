set global innodb_fast_shutdown = 0;
CREATE TABLE t1 (y YEAR, vy YEAR AS (y) VIRTUAL, pk INT,
PRIMARY KEY(pk), UNIQUE(vy)) ENGINE=InnoDB;
INSERT IGNORE INTO t1 (pk,y) VALUES (1,2022);
CREATE TABLE t2(f1 INT NOT NULL, PRIMARY KEY(f1))ENGINE=InnoDB;
set global debug_dbug = 'd,ib_purge_virtual_index_callback';
BEGIN;
INSERT INTO t2(f1) VALUES(1);
connect  con1, localhost,root,,;
START TRANSACTION WITH CONSISTENT SNAPSHOT;
connection default;
SET @saved_frequency = @@GLOBAL.innodb_purge_rseg_truncate_frequency;
SET GLOBAL innodb_purge_rseg_truncate_frequency = 1;
COMMIT;
connect con2,localhost,root,,;
REPLACE INTO t1(pk, y) SELECT pk,y FROM t1;
SET DEBUG_SYNC='row_trunc_before_dict_lock SIGNAL commit_trx WAIT_FOR release_lock';
TRUNCATE TABLE t1;
connection con1;
SET DEBUG_SYNC='now WAIT_FOR commit_trx';
commit;
SET DEBUG_SYNC='now SIGNAL purge_start';
disconnect con1;
connection default;
SET DEBUG_SYNC='now WAIT_FOR purge_start';
InnoDB		1 transactions not purged
SET DEBUG_SYNC='now SIGNAL release_lock';
connection con2;
disconnect con2;
connection default;
InnoDB		0 transactions not purged
drop table t1, t2;
SET GLOBAL innodb_purge_rseg_truncate_frequency = @saved_frequency;
SET DEBUG_SYNC='RESET';
set global debug_dbug = 'RESET';
